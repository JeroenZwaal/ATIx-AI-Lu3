name: Security (SCA/SAST/SBOM)

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
    inputs:
      demo_fail:
        description: "Run an intentional failing job to demonstrate security gates"
        required: false
        default: false
        type: boolean

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

jobs:
  codeql:
    name: SAST (CodeQL)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
          config-file: ./.github/codeql-config.yml

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install backend deps
        run: cd backend && npm ci

      - name: Install frontend deps
        run: cd frontend && npm ci

      - name: Build backend
        run: cd backend && npm run build

      - name: Build frontend
        run: cd frontend && npm run build

      - name: Analyze
        uses: github/codeql-action/analyze@v4
        with:
          output: codeql-results

      - name: Gate - fail on CodeQL error-level results
        run: |
          set -euo pipefail
          if ! compgen -G "codeql-results/**/*.sarif" > /dev/null; then
            echo "No SARIF files found in codeql-results; skipping gate."
            exit 0
          fi
          error_count=$(jq '[.runs[].results[]? | select(.level == "error")] | length' codeql-results/**/*.sarif | awk '{s+=$1} END {print s+0}')
          echo "CodeQL error-level findings: ${error_count}"
          if [ "${error_count}" -gt 0 ]; then
            echo "Failing build due to CodeQL error-level findings."
            exit 1
          fi

  trivy:
    name: SCA (Trivy fs scan)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Trivy (SARIF)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          scan-type: fs
          scan-ref: .
          format: sarif
          output: trivy-results.sarif
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          scanners: vuln,secret,misconfig
          exit-code: "0"

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: ${{ github.event_name == 'pull_request' }}
        with:
          sarif_file: trivy-results.sarif

      - name: Trivy (JSON report)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          scan-type: fs
          scan-ref: .
          format: json
          output: trivy-results.json
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          scanners: vuln,secret,misconfig
          exit-code: "0"
          skip-setup-trivy: true

      - name: Gate - fail on Trivy findings (HIGH/CRITICAL vulns, any secrets)
        run: |
          set -euo pipefail
          vuln_count=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "HIGH" or .Severity == "CRITICAL")] | length' trivy-results.json)
          misconfig_count=$(jq '[.Results[].Misconfigurations[]? | select(.Severity == "HIGH" or .Severity == "CRITICAL")] | length' trivy-results.json)
          secret_count=$(jq '[.Results[].Secrets[]?] | length' trivy-results.json)

          echo "Trivy HIGH/CRITICAL vulnerabilities: ${vuln_count}"
          echo "Trivy HIGH/CRITICAL misconfigurations: ${misconfig_count}"
          echo "Trivy secrets found: ${secret_count}"

          if [ "${vuln_count}" -gt 0 ] || [ "${misconfig_count}" -gt 0 ] || [ "${secret_count}" -gt 0 ]; then
            echo "Failing build due to Trivy findings."
            exit 1
          fi

      - name: Upload Trivy reports
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports
          path: |
            trivy-results.sarif
            trivy-results.json
          retention-days: 30

  npm-audit:
    name: SCA (npm audit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Backend npm audit (JSON)
        run: |
          set -euo pipefail
          cd backend
          npm ci
          npm audit --audit-level=high --json | tee ../backend-npm-audit.json

      - name: Frontend npm audit (JSON)
        run: |
          set -euo pipefail
          cd frontend
          npm ci
          npm audit --audit-level=high --json | tee ../frontend-npm-audit.json

      - name: Upload npm audit reports
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-reports
          path: |
            backend-npm-audit.json
            frontend-npm-audit.json
          retention-days: 30

  sbom:
    name: SBOM + CVE gate (Trivy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Trivy CLI
        uses: aquasecurity/setup-trivy@7483281e2107e7eecac919ed9d4f5ce2d89e4614
        with:
          version: latest

      - name: Generate SBOM (CycloneDX)
        run: |
          set -euo pipefail
          trivy fs --format cyclonedx --output sbom.cdx.json .

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: sbom.cdx.json
          retention-days: 30

      - name: Gate - scan SBOM for HIGH/CRITICAL CVEs
        run: |
          set -euo pipefail
          trivy sbom --severity HIGH,CRITICAL --ignore-unfixed --exit-code 1 sbom.cdx.json

  gate-demo:
    name: Fail-example (intentional)
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.demo_fail }}
    runs-on: ubuntu-latest
    steps:
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Create intentionally vulnerable npm project
        run: |
          set -euo pipefail
          mkdir -p /tmp/vuln-demo
          cd /tmp/vuln-demo
          cat > package.json << 'JSON'
          {
            "name": "vuln-demo",
            "version": "1.0.0",
            "private": true,
            "dependencies": {
              "minimist": "1.2.5"
            }
          }
          JSON
          npm install --package-lock-only

      - name: Demonstrate SCA gate (expected to fail)
        run: |
          set -euo pipefail
          cd /tmp/vuln-demo
          npm audit --audit-level=high
